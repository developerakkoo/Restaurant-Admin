"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1634],{1634:(G,C,g)=>{g.r(C),g.d(C,{ChatPageModule:()=>$});var p=g(177),u=g(4341),a=g(4488),_=g(8986),m=g(467),e=g(4438),b=g(4796),x=g(6994);const v=["messagesContainer"];function M(i,c){1&i&&(e.j41(0,"ion-text",13)(1,"h1"),e.EFF(2,"No conversations"),e.k0s()())}function P(i,c){if(1&i){const s=e.RV6();e.j41(0,"ion-item",16),e.bIt("click",function(){const n=e.eBV(s).$implicit,o=e.XpG(2);return e.Njj(o.openChat(n))}),e.j41(1,"ion-avatar",17),e.nrm(2,"img",18),e.k0s(),e.j41(3,"ion-label",19)(4,"h3"),e.EFF(5),e.k0s(),e.j41(6,"p",20),e.EFF(7),e.k0s()(),e.j41(8,"ion-badge",21),e.EFF(9),e.nI1(10,"date"),e.k0s()()}if(2&i){const s=c.$implicit,t=e.XpG(2);e.AVh("active",s._id===t.chatId),e.R7$(2),e.Y8G("src",s.user.profileImage||"assets/icon/favicon.png",e.B4B),e.R7$(3),e.JRh(s.user.phoneNumber),e.R7$(2),e.JRh(s.lastMessage.text||"Image received"),e.R7$(2),e.SpI(" ",e.i5U(10,6,s.lastMessage.time,"shortDate")," ")}}function k(i,c){if(1&i&&(e.j41(0,"ion-list",14),e.DNE(1,P,11,9,"ion-item",15),e.k0s()),2&i){const s=e.XpG();e.R7$(),e.Y8G("ngForOf",s.activeChats)}}function O(i,c){1&i&&(e.j41(0,"ion-text",13)(1,"h1"),e.EFF(2,"No messages yet"),e.k0s(),e.j41(3,"p"),e.EFF(4,"Start a conversation!"),e.k0s()())}function I(i,c){if(1&i&&(e.j41(0,"div",38)(1,"div",39)(2,"p",40),e.EFF(3),e.k0s(),e.j41(4,"span",41),e.EFF(5),e.nI1(6,"date"),e.k0s()()()),2&i){const s=c.$implicit;e.AVh("sent",!s.isUser)("received",s.isUser),e.R7$(3),e.JRh(s.text),e.R7$(2),e.JRh(e.i5U(6,6,s.time,"shortTime"))}}function y(i,c){if(1&i&&(e.j41(0,"div",36),e.DNE(1,I,7,9,"div",37),e.k0s()),2&i){const s=e.XpG(2);e.R7$(),e.Y8G("ngForOf",s.messages)}}function w(i,c){if(1&i){const s=e.RV6();e.j41(0,"ion-col",22)(1,"ion-card",23)(2,"ion-card-header",24)(3,"ion-item",25)(4,"ion-avatar",26),e.nrm(5,"img",27),e.k0s(),e.j41(6,"ion-label")(7,"h2"),e.EFF(8),e.k0s(),e.j41(9,"p"),e.EFF(10,"Online"),e.k0s()()()(),e.j41(11,"ion-card-content",28)(12,"div",29,0),e.DNE(14,O,5,0,"ion-text",9)(15,y,2,1,"div",30),e.k0s()(),e.j41(16,"div",31)(17,"ion-item",32)(18,"ion-input",33),e.mxI("ngModelChange",function(n){e.eBV(s);const o=e.XpG();return e.DH7(o.message,n)||(o.message=n),e.Njj(n)}),e.bIt("keyup.enter",function(){e.eBV(s);const n=e.XpG();return e.Njj(n.sendMessage())}),e.k0s(),e.j41(19,"ion-button",34),e.bIt("click",function(){e.eBV(s);const n=e.XpG();return e.Njj(n.sendMessage())}),e.nrm(20,"ion-icon",35),e.k0s()()()()()}if(2&i){const s=e.XpG();e.R7$(5),e.Y8G("src",s.selectedChatUserImage,e.B4B),e.R7$(3),e.JRh(s.chatName||"..."),e.R7$(6),e.Y8G("ngIf",0===s.messages.length),e.R7$(),e.Y8G("ngIf",s.messages.length>0),e.R7$(3),e.R50("ngModel",s.message),e.R7$(),e.Y8G("disabled",!s.message.trim())}}function j(i,c){1&i&&(e.j41(0,"ion-col",42)(1,"ion-card",43)(2,"ion-card-content",44),e.nrm(3,"ion-icon",45),e.j41(4,"h2"),e.EFF(5,"Select a conversation"),e.k0s(),e.j41(6,"p"),e.EFF(7,"Choose a conversation from the list to start chatting"),e.k0s()()()())}const R=[{path:"",component:(()=>{var i;class c{constructor(t,n,o){this.auth=t,this.socket=n,this.loadingController=o,this.messages=[],this.activeChats=[],this.chatName="",this.message="",this.orderId="",this.senderId="",this.receiverId="",this.chatId="",this.selectedChatUserImage="assets/icon/favicon.png",this.chatRoomUserId=null}ngOnInit(){this.senderId=this.auth.userId.value||"",this.initializeSocketListeners()}ionViewDidEnter(){this.getAllChats()}ionViewDidLeave(){clearInterval(this.interval),this.socket.removeAllListeners("chatMessage"),this.socket.disconnect()}onSearchChange(t){}scrolToBottom(){setTimeout(()=>{if(this.messagesContainer){const t=this.messagesContainer.nativeElement;t.scrollTop=t.scrollHeight}},100)}getAllChats(){var n,t=this;this.auth.getAllChats().subscribe({next:(n=(0,m.A)(function*(o){t.activeChats=(o.data||[]).map(r=>({...r,unreadCount:r.unreadCount||0})),t.sortActiveChats()}),function(r){return n.apply(this,arguments)}),error:function(){var n=(0,m.A)(function*(o){console.log(o.error)});return function(r){return n.apply(this,arguments)}}()})}openChat(t){var n,o,r,d,h;const l=this.normalizeId((null===(n=t.user)||void 0===n?void 0:n._id)||t._id);this.orderId=(null===(o=t.lastMessage)||void 0===o?void 0:o.orderId)||null,this.receiverId=l,this.chatId=l,this.chatName=(null===(r=t.user)||void 0===r?void 0:r.phoneNumber)||(null===(d=t.user)||void 0===d?void 0:d.name)||"Customer",this.selectedChatUserImage=(null===(h=t.user)||void 0===h?void 0:h.profileImage)||"assets/icon/favicon.png",this.joinChatRoom(l),this.messages=[],this.getMessagesByChatId(),this.markChatAsRead(l)}getMessagesByChatId(){var n,t=this;this.receiverId&&this.auth.getMessagesByChatId(this.receiverId).subscribe({next:(n=(0,m.A)(function*(o){t.messages=o.data||[],t.scrolToBottom()}),function(r){return n.apply(this,arguments)}),error:function(){var n=(0,m.A)(function*(o){console.log(o.error)});return function(r){return n.apply(this,arguments)}}()})}sendMessage(){const t=this.message.trim();if(!t||!this.chatId||!this.receiverId)return;const n={text:t,adminId:this.senderId,userId:this.receiverId,isUser:!1,time:new Date,orderId:this.orderId||null};this.socket.emit("sendMessage",n);const o={...n,isRead:!0};this.messages.push(o),this.updateChatPreview(this.receiverId,o,!0),this.scrolToBottom(),this.message=""}initializeSocketListeners(){this.socket.ioSocket.connected||this.socket.connect(),this.socket.on("connect",()=>{console.log("Socket connected")}),this.socket.on("chatMessage",t=>{this.handleIncomingMessage(t)})}handleIncomingMessage(t){if(!t)return;const n=this.normalizeId(t.userId);n&&(!!this.receiverId&&n===this.receiverId&&(this.messages.push(t),this.scrolToBottom(),this.markChatAsRead(n)),this.updateChatPreview(n,t,!1===t.isUser&&t.adminId===this.senderId))}joinChatRoom(t){t&&(this.chatRoomUserId=t,this.socket.emit("joinChatRoom",{isAdmin:!0,userId:t,adminId:this.senderId}))}markChatAsRead(t){t&&this.auth.markChatAsRead(t).subscribe({next:()=>this.getAllChats(),error:n=>console.error("Failed to mark chat as read",n)})}updateChatPreview(t,n,o){if(!t)return;const r=this.activeChats.findIndex(l=>{var f;return this.normalizeId((null===(f=l.user)||void 0===f?void 0:f._id)||l._id)===t});if(-1===r)return void this.getAllChats();const d=this.activeChats[r],h=t===this.receiverId||o?0:(d.unreadCount||0)+1;this.activeChats[r]={...d,lastMessage:{...d.lastMessage||{},...n},unreadCount:h},this.sortActiveChats()}sortActiveChats(){this.activeChats.sort((t,n)=>{var o,r;const d=new Date((null===(o=t.lastMessage)||void 0===o?void 0:o.time)||0).getTime();return new Date((null===(r=n.lastMessage)||void 0===r?void 0:r.time)||0).getTime()-d})}normalizeId(t){return t?"string"==typeof t?t:"object"==typeof t&&t._id?t._id.toString():t.toString?t.toString():"":""}}return(i=c).\u0275fac=function(t){return new(t||i)(e.rXU(b.u),e.rXU(x.yQ),e.rXU(a.Xi))},i.\u0275cmp=e.VBU({type:i,selectors:[["app-chat"]],viewQuery:function(t,n){if(1&t&&(e.GBs(a.W9,5),e.GBs(v,5)),2&t){let o;e.mGM(o=e.lsd())&&(n.content=o.first),e.mGM(o=e.lsd())&&(n.messagesContainer=o.first)}},decls:18,vars:7,consts:[["messagesContainer",""],[3,"translucent"],[1,"chat-container",3,"fullscreen"],[1,"chat-grid"],[1,"chat-row"],["size","4",1,"profiles-panel"],[1,"profiles-card"],["placeholder","Search conversations","showCancelButton","always",3,"ionChange","debounce"],[1,"profiles-content"],["color","primary","class","ion-text-center",4,"ngIf"],["class","profiles-list",4,"ngIf"],["size","8","class","chat-panel",4,"ngIf"],["size","8","class","empty-state",4,"ngIf"],["color","primary",1,"ion-text-center"],[1,"profiles-list"],["class","profile-item","button","",3,"active","click",4,"ngFor","ngForOf"],["button","",1,"profile-item",3,"click"],["slot","start",1,"profile-avatar"],["alt","Profile",3,"src"],[1,"profile-info"],[1,"last-message"],["color","light","mode","ios",1,"time-badge"],["size","8",1,"chat-panel"],[1,"chat-card"],[1,"chat-header"],[1,"chat-user-info"],["slot","start",1,"user-avatar"],["alt","User Profile",3,"src"],[1,"messages-content"],[1,"messages-container"],["class","message-list",4,"ngIf"],[1,"message-input-container"],[1,"input-item"],["fill","outline","type","text","placeholder","Type a message...",1,"message-input",3,"ngModelChange","keyup.enter","ngModel"],["fill","clear",1,"send-button",3,"click","disabled"],["slot","icon-only","name","send"],[1,"message-list"],["class","message-item",3,"sent","received",4,"ngFor","ngForOf"],[1,"message-item"],[1,"message-bubble"],[1,"message-text"],[1,"message-time"],["size","8",1,"empty-state"],[1,"empty-card"],[1,"empty-content"],["name","chatbubbles-outline",1,"empty-icon"]],template:function(t,n){1&t&&(e.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Chat"),e.k0s()()(),e.j41(4,"ion-content",2)(5,"ion-grid",3)(6,"ion-row",4)(7,"ion-col",5)(8,"ion-card",6)(9,"ion-card-header")(10,"ion-card-title"),e.EFF(11,"Conversations"),e.k0s(),e.j41(12,"ion-searchbar",7),e.bIt("ionChange",function(r){return n.onSearchChange(r)}),e.k0s()(),e.j41(13,"ion-card-content",8),e.DNE(14,M,3,0,"ion-text",9)(15,k,2,1,"ion-list",10),e.k0s()()(),e.DNE(16,w,21,6,"ion-col",11)(17,j,8,0,"ion-col",12),e.k0s()()()),2&t&&(e.Y8G("translucent",!0),e.R7$(4),e.Y8G("fullscreen",!0),e.R7$(8),e.Y8G("debounce",250),e.R7$(2),e.Y8G("ngIf",0===n.activeChats.length),e.R7$(),e.Y8G("ngIf",n.activeChats.length>0),e.R7$(),e.Y8G("ngIf",n.chatId),e.R7$(),e.Y8G("ngIf",!n.chatId))},dependencies:[p.Sq,p.bT,u.BC,u.vS,a.mC,a.In,a.Jm,a.b_,a.I9,a.ME,a.tN,a.hU,a.W9,a.lO,a.eU,a.iq,a.$w,a.uz,a.he,a.nf,a.ln,a.S1,a.IO,a.BC,a.ai,a.Gw,p.vh],styles:[".chat-container[_ngcontent-%COMP%]{--background: #f5f5f5;height:100vh}.chat-grid[_ngcontent-%COMP%]{height:100%;padding:0}.chat-row[_ngcontent-%COMP%]{height:100%}.profiles-panel[_ngcontent-%COMP%]{height:100%;padding:0}.profiles-card[_ngcontent-%COMP%]{height:100%;margin:0;border-radius:0;box-shadow:2px 0 8px #0000001a}.profiles-content[_ngcontent-%COMP%]{height:calc(100% - 120px);padding:0;overflow:hidden}.profiles-list[_ngcontent-%COMP%]{height:100%;overflow-y:auto;padding:0}.profile-item[_ngcontent-%COMP%]{--padding-start: 16px;--padding-end: 16px;--padding-top: 12px;--padding-bottom: 12px;--border-radius: 0;--background: transparent;--background-hover: #f0f0f0;--background-activated: #e0e0e0;border-bottom:1px solid #e0e0e0;cursor:pointer;transition:background-color .2s ease}.profile-item.active[_ngcontent-%COMP%]{--background: #e3f2fd;--background-hover: #e3f2fd;border-left:4px solid #2196f3}.profile-item[_ngcontent-%COMP%]:hover{--background: #f5f5f5}.profile-avatar[_ngcontent-%COMP%]{width:48px;height:48px;margin-right:12px}.profile-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{border-radius:50%;object-fit:cover}.profile-info[_ngcontent-%COMP%]{flex:1;margin:0}.profile-info[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:16px;font-weight:600;margin:0 0 4px;color:#333}.profile-info[_ngcontent-%COMP%]   .last-message[_ngcontent-%COMP%]{font-size:14px;color:#666;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}.time-badge[_ngcontent-%COMP%]{font-size:12px;padding:4px 8px;border-radius:12px;background:#f0f0f0;color:#666}.chat-panel[_ngcontent-%COMP%]{height:100%;padding:0}.chat-card[_ngcontent-%COMP%]{height:100%;margin:0;border-radius:0;display:flex;flex-direction:column}.chat-header[_ngcontent-%COMP%]{padding:16px;border-bottom:1px solid #e0e0e0;background:#fff;flex-shrink:0}.chat-user-info[_ngcontent-%COMP%]{--background: transparent;--padding-start: 0;--padding-end: 0;--inner-padding-start: 0;--inner-padding-end: 0}.chat-user-info[_ngcontent-%COMP%]   .user-avatar[_ngcontent-%COMP%]{width:40px;height:40px;margin-right:12px}.chat-user-info[_ngcontent-%COMP%]   .user-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{border-radius:50%;object-fit:cover}.chat-user-info[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:18px;font-weight:600;margin:0 0 4px;color:#333}.chat-user-info[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:#4caf50;margin:0}.messages-content[_ngcontent-%COMP%]{flex:1;padding:0;overflow:hidden;background:#f8f9fa}.messages-container[_ngcontent-%COMP%]{height:100%;padding:16px;overflow-y:auto;display:flex;flex-direction:column}.message-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.message-item[_ngcontent-%COMP%]{display:flex;margin-bottom:8px}.message-item.sent[_ngcontent-%COMP%]{justify-content:flex-end}.message-item.sent[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background:#2196f3;color:#fff;border-bottom-right-radius:4px}.message-item.received[_ngcontent-%COMP%]{justify-content:flex-start}.message-item.received[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background:#fff;color:#333;border-bottom-left-radius:4px;box-shadow:0 1px 3px #0000001a}.message-bubble[_ngcontent-%COMP%]{max-width:70%;padding:12px 16px;border-radius:18px;position:relative}.message-bubble[_ngcontent-%COMP%]   .message-text[_ngcontent-%COMP%]{margin:0 0 4px;font-size:14px;line-height:1.4;word-wrap:break-word}.message-bubble[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{font-size:11px;opacity:.7;display:block;text-align:right}.message-input-container[_ngcontent-%COMP%]{padding:16px;border-top:1px solid #e0e0e0;background:#fff;flex-shrink:0}.input-item[_ngcontent-%COMP%]{--background: transparent;--padding-start: 0;--padding-end: 0;--inner-padding-start: 0;--inner-padding-end: 0;display:flex;align-items:center;gap:8px}.message-input[_ngcontent-%COMP%]{flex:1;--padding-start: 16px;--padding-end: 16px;--padding-top: 12px;--padding-bottom: 12px;border-radius:24px;background:#f5f5f5;border:1px solid #e0e0e0}.send-button[_ngcontent-%COMP%]{--padding-start: 8px;--padding-end: 8px;--color: #2196f3;--color-disabled: #ccc;height:40px;width:40px;border-radius:50%;background:#2196f3;color:#fff}.send-button[_ngcontent-%COMP%]:disabled{background:#e0e0e0;color:#ccc}.send-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px}.empty-state[_ngcontent-%COMP%]{height:100%;display:flex;align-items:center;justify-content:center}.empty-card[_ngcontent-%COMP%]{text-align:center;background:transparent;box-shadow:none}.empty-content[_ngcontent-%COMP%]{padding:40px 20px}.empty-content[_ngcontent-%COMP%]   .empty-icon[_ngcontent-%COMP%]{font-size:64px;color:#ccc;margin-bottom:16px}.empty-content[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:24px;font-weight:600;color:#666;margin:0 0 8px}.empty-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;color:#999;margin:0}@media (max-width: 768px){.profiles-panel[_ngcontent-%COMP%], .chat-panel[_ngcontent-%COMP%]{size:12}.message-bubble[_ngcontent-%COMP%]{max-width:85%}}.profiles-list[_ngcontent-%COMP%]::-webkit-scrollbar, .messages-container[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.profiles-list[_ngcontent-%COMP%]::-webkit-scrollbar-track, .messages-container[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f1f1}.profiles-list[_ngcontent-%COMP%]::-webkit-scrollbar-thumb, .messages-container[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}.profiles-list[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover, .messages-container[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#a8a8a8}"]}),c})()}];let F=(()=>{var i;class c{}return(i=c).\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.$C({type:i}),i.\u0275inj=e.G2t({imports:[_.iI.forChild(R),_.iI]}),c})(),$=(()=>{var i;class c{}return(i=c).\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.$C({type:i}),i.\u0275inj=e.G2t({imports:[p.MD,u.YN,a.bv,F]}),c})()}}]);