<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-title>Orders</ion-title>
    <ion-button color="primary" (click)="handleRefresh()" slot="end" fill="clear" [disabled]="isRefreshing">
      <ion-icon slot="icon-only" name="refresh-outline" [class.spinning]="isRefreshing"></ion-icon>
    </ion-button>
    <ion-button color="primary" (click)="viewNotifications()" slot="end" fill="clear">
      <ion-icon slot="icon-only" name="notifications-circle-outline"></ion-icon>
    </ion-button>
    <ion-button color="primary" (click)="viewNotifications()" slot="end" fill="clear">
      <ion-icon slot="icon-only" name="chatbox-ellipses-outline"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h2>ðŸ“¦ Order Management</h2>
        <p>Track and manage all customer orders</p>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <ion-grid>
      <ion-row>
        <ion-col size="5" size-md="5">
          <ion-select
            style="width: 100%; --height: 40px"
            value=""
            fill="outline"
            interface="popover"
            label="Status"
            labelPlacement="stacked"
            (ionChange)="filterEvent($event)"
          >
            <ion-select-option *ngFor="let option of statusOptions" [value]="option.value">
              {{option.label}}
            </ion-select-option>
          </ion-select>
        </ion-col>
        <ion-col size="3" size-md="3">
          <ion-input
            style="width: 100%; --height: 40px"
            type="date"
            label="Start Date"
            labelPlacement="stacked"
            fill="outline"
            (ionChange)="setDateEvent($event, 's')"
            placeholder="Start Date"
          ></ion-input>
        </ion-col>
        <ion-col size="3" size-md="3">
          <ion-input
            style="width: 100%; --height: 40px"
            type="date"
            label="End Date"
            labelPlacement="stacked"
            fill="outline"
            (ionChange)="setDateEvent($event, 'e')"
            placeholder="End Date"
          ></ion-input>
        </ion-col>
        <ion-col size="1" size-md="1">
          <ion-button fill="clear" (click)="downloadExcelSheet()" class="download-btn">
            <ion-icon slot="icon-only" name="download-outline"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Search Bar -->
    <div class="search-container">
      <ion-searchbar 
        placeholder="Search orders..." 
        [(ngModel)]="searchTerm"
        (ionInput)="filterOrders()"
        show-clear-button="focus">
      </ion-searchbar>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-container" *ngIf="orders.length > 0">
    <div class="table-card">
      <div class="table-header">
        <h3>Order List</h3>
        <ion-badge color="primary">{{ orders.length }} Orders</ion-badge>
      </div>
      
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
            <tr>
              <th>#ID</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Address</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of orders" class="table-row">
              <td class="order-id-cell">{{ order.orderId }}</td>
              <td class="date-cell">{{ order.createdAt | date:'short' }}</td>
              <td class="customer-cell">{{ order.user?.phoneNumber }}</td>
              <td class="address-cell">{{ order.userAddress?.address }}</td>
              <td class="amount-cell">{{ order.priceDetails?.totalAmountToPay | currency: 'INR' }}</td>
              <td class="status-cell">
                <ion-badge [color]="getStatusColor(order.orderStatus ?? order.status ?? 0)" mode="ios" class="status-badge">
                  <ion-icon 
                    *ngIf="getStatusIcon(order.orderStatus ?? order.status ?? 0)" 
                    [name]="getStatusIcon(order.orderStatus ?? order.status ?? 0)" 
                    slot="start"
                  ></ion-icon>
                  {{ getStatusText(order.orderStatus ?? order.status ?? 0) }}
                </ion-badge>
                <p>{{order.orderStatus ?? order.status}}</p>
              </td>
              <td class="actions-cell">
                <div class="action-buttons">
                  <ion-badge color="secondary" mode="ios" class="action-badge" (click)="openDetailsPage(order._id)">
                    <ion-icon name="eye-outline" slot="start"></ion-icon>
                    View
                  </ion-badge>
                  
                  <ion-badge
                    *ngIf="canAdminPerformAction(order?.orderStatus ?? order?.status ?? 0) && (order?.orderStatus ?? order?.status ?? 0) === 0"
                    color="success"
                    mode="ios"
                    class="action-badge"
                    (click)="presentActionSheet(order._id)"
                  >
                    <ion-icon name="checkmark-outline" slot="start"></ion-icon>
                    Accept
                  </ion-badge>

                  <ion-select
                    (ionChange)="assignDriverEvent($event, order._id)"
                    *ngIf="canAdminPerformAction(order?.orderStatus) && ((order?.orderStatus) === 4 || (order?.orderStatus) === 1)"
                    fill="outline"
                    multiple="true"
                    interface="alert"
                    cancelText="Cancel"
                    okText="Assign"
                    placeholder="Select Driver"
                    class="driver-select"
                  >
                    <ion-select-option *ngFor="let d of drivers" [value]="d._id">
                      {{d.firstName}} {{d.lastName}}
                    </ion-select-option>
                  </ion-select>
                  
                  <!-- Display assigned delivery boys -->
                  <div *ngIf="order?.assignedDeliveryBoys && order.assignedDeliveryBoys.length > 0" class="assigned-drivers">
                    <ion-text color="medium" class="assigned-label">
                      <small>Assigned Drivers:</small>
                    </ion-text>
                    <div class="driver-badges">
                      <ion-badge 
                        *ngFor="let driverId of order.assignedDeliveryBoys" 
                        color="tertiary"
                        class="driver-badge"
                      >
                        {{ getDriverName(driverId) }}
                      </ion-badge>
                    </div>
                  </div>
                  
                  <!-- Display accepted delivery boy if different from assigned -->
                  <div *ngIf="order?.assignedDeliveryBoy && (!order?.assignedDeliveryBoys || !order.assignedDeliveryBoys.includes(order.assignedDeliveryBoy))" class="accepted-driver">
                    <ion-text color="success" class="accepted-label">
                      <small>Accepted by: {{ getDriverName(order.assignedDeliveryBoy) }}</small>
                    </ion-text>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="orders.length > pageSize">
    <nav>
      <ul class="pagination justify-content-end">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="changePage(currentPage - 1)">Previous</a>
        </li>
        <li
          class="page-item"
          *ngFor="let page of totalPagesArray()"
          [class.active]="page === currentPage"
        >
          <a class="page-link" (click)="changePage(page)">{{ page }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="changePage(currentPage + 1)">Next</a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="orders.length === 0">
    <ion-icon name="receipt-outline" class="empty-icon"></ion-icon>
    <h3>No Orders Found!</h3>
    <p>Orders will appear here once customers start placing them</p>
  </div>
</ion-content>
